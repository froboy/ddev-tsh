#ddev-generated
## This file may need to be modified to suit your Teleport configuration.
## If you modify the file, remove #ddev-generated from the first line.
#!/usr/bin/env bash

## Description: Log in to Teleport and our project cluster.
## Usage: tsh-login [<env>]
## Example: "ddev tsh-login dev"

set -e

if [ $# -gt 1 ]; then
  echo "Usage: $0 [<env>]" >&2
  echo "  <env> must be one of: dev (development, devel, d), stg (stage, staging, s), prd (prod, production, p). Defaults to prod if omitted." >&2
  exit 1
fi

if [ $# -eq 0 ]; then
  ENV_INPUT="prd"
else
  ENV_INPUT=$(echo "$1" | tr '[:upper:]' '[:lower:]')
fi

case "$ENV_INPUT" in
  dev|development|devel|d)
    CLUSTER_VAR="KUBE_CLUSTER_DEV"
    ENV_LABEL="dev"
    ;;
  stg|stage|staging|s)
    CLUSTER_VAR="KUBE_CLUSTER_STG"
    ENV_LABEL="stg"
    ;;
  prd|prod|production|p)
    CLUSTER_VAR="KUBE_CLUSTER_PRD"
    ENV_LABEL="prd"
    ;;
  *)
    echo "Invalid environment: $ENV_INPUT. Must be one of: dev (development, devel, d), stg (stage, staging, s), prd (prod, production, p)." >&2
    exit 1
    ;;
esac

KUBE_CLUSTER_VALUE="${!CLUSTER_VAR}"

if [ -z "${TELEPORT_USER}" ] || [ -z "${TELEPORT_PROXY}" ] || [ -z "${TELEPORT_CLUSTER}" ]; then
  echo "TELEPORT_USER, TELEPORT_PROXY, and TELEPORT_CLUSTER environment variables must be set." >&2
  echo "See docs for how to set them, or re-install the addon." >&2
  exit 1
fi

if [ -z "$KUBE_CLUSTER_VALUE" ]; then
  echo "$CLUSTER_VAR environment variable must be set for env '$ENV_LABEL'." >&2
  exit 1
fi

# These variables don't need to be specified since they already exist as
# environment variables in the web container, but we set them here for clarity.
tsh login --proxy=${TELEPORT_PROXY} --user=${TELEPORT_USER} ${TELEPORT_CLUSTER}

tsh kube login "$KUBE_CLUSTER_VALUE"

kubectl version | grep "Server Version" >/dev/null 2>&1
kubestatus=$?

if [ ${kubestatus} -eq 0 ]; then
  echo "Successfully logged in to Teleport and Kubernetes cluster ($KUBE_CLUSTER_VALUE)."
else
  echo "Failed to log in to Teleport or Kubernetes cluster ($KUBE_CLUSTER_VALUE)."
  exit 1
fi
